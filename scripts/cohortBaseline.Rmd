---
title: "Initial Study Baseline"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
```

```{r, message = F, warning = F}
# Loading libraries
packages <- c(
  "dplyr", "ggplot2", "tidyverse",
  "repr", "ggsci", "ggrepel", 
  "lubridate", "forcats", "ggpubr"
)
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
lapply(packages, require, character.only = TRUE)
```


```{r}
white <- 8527
black <- 8516

male <- 8507
female <- 8532
```


```{r}
# Reading the data dictionary
baseName <- "/Users/mhy3/Box/CHAI_UPLOAD_BOX/04212022-study_initial_baseline/"
data <- read.csv(paste0(baseName, "data_dictionary.csv"))
head(data)


data %>% distinct(race)

csvFiles <- data %>%
  filter(
    condition == "Bipolar Disorder",
    race == "White" | race == "Black or African American"
  ) %>%
  select(id) %>%
  as.list()

csvFiles



bd_white <- data %>%
  filter(
    condition == "Bipolar Disorder",
    race == "White",
    gender == "Male"
  ) %>%
  select(id) %>%
  as.list()
```


```{r}
# Looking at some of the csv files
csvFiles$id[1]

rbind(read.csv(paste0(baseName, 817, ".csv")), read.csv(paste0(baseName, 705, ".csv"))) %>% arrange(age_group)


cohort <- data.frame()
for (i in bd_white$id[-length(bd_white$id)]) {
  cohort <- rbind(cohort, read.csv(paste0(baseName, i, ".csv")))
}

cohort %>%
  arrange(age_group) %>%
  distinct()
```

```{r}
# This function will take in 2 parameters:
# dataDictionary--master list with all the csv files
# condition--Bipolar Disorder, Depression, Suicidality
# race--Asian, American Indian or Alaskan Indian, White,
#       Native Hawaiian or Other Pacific Islander,
#       Black or African American, Other Race
# @examples
# \dontrun{
# gettingCounts(data, "Bipolar Disorder", "White", "Male")
# getCounts(data, "Bipolar Disorder")
# }


# gettingCounts <- function(dataDictionary, condition, race, gender){
#    cohort <- data.frame()
#    ids <- dataDictionary %>% filter(condition == !!condition,
#                                    race == !!race,
#                                    gender == !!gender)
#    for(i in ids$id){
#       df <- read.csv(paste0(baseName, i, ".csv"))
#       if(dim(df)[2] == 5){
#          cohort <- rbind(cohort, df)
#       } else{
#          next
#       }
#    }
#    cohort <- cohort %>% arrange(age_group) %>% distinct()
#    return(cohort)
# }

getCounts <- function(dataDictionary, conditionName) {
  ids <- dataDictionary %>% filter(condition == !!conditionName)
  cohort <- data.frame()
  for (i in ids$id) {
    df <- read.csv(paste0(baseName, i, ".csv"))
    if (dim(df)[2] == 5) {
      cohort <- rbind(cohort, df)
    } else {
      # print(i)
      next
    }
  }
  cohort <- cohort %>%
    mutate(
      race_concept_id = as.factor(race_concept_id),
      state = as.factor(state),
      age_group = as.factor(age_group),
      gender_concept_id = as.factor(gender_concept_id),
      condition = as.factor(conditionName)
    ) %>%
    arrange(age_group) %>%
    distinct() %>% 
    mutate(race_concept_id = recode(race_concept_id, 
                                    "8527" = "White", 
                                    "8516" = "Black or African American", 
                                    "8515" = "Asian", 
                                    "8522" = "Other Race", 
                                    "8657" = "American Indian or Alaska Native"),
           gender_concept_id = recode(gender_concept_id, 
                                      "8507" = "Male", 
                                      "8532" = "Female"))
  return(cohort)
}

bipolar <- getCounts(data, "Bipolar Disorder")
depression <- getCounts(data, "Depression")
suicidality <- getCounts(data, "Suicidality")
```

```{r Heatmaps}
#scale_fill_discrete(labels = c("8507" = "Male", "8532" = "Female"))
#scale_fill_nejm(labels = function(x) str_wrap(x, width = 12)) + 

bipolar %>% 
  group_by(race_concept_id, age_group) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(value = count/sum(count)) %>% 
  ggplot(aes(x = age_group, y = race_concept_id))+
  geom_tile(aes(fill = value)) + 
  theme(axis.title = element_blank()) + 
  labs(title = "Heatmap of Race and Age Groups", subtitle = "Bipolar Disorder")


depression %>% 
  group_by(race_concept_id, age_group) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(value = count/sum(count)) %>% 
  ggplot(aes(x = age_group, y = race_concept_id))+
  geom_tile(aes(fill = value)) + 
  theme(axis.title = element_blank()) + 
  labs(title = "Heatmap of Race and Age Groups", subtitle = "Depression")

suicidality %>% 
  group_by(race_concept_id, age_group) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(value = count/sum(count)) %>% 
  ggplot(aes(x = age_group, y = race_concept_id))+
  geom_tile(aes(fill = value)) + 
  theme(axis.title = element_blank()) + 
  labs(title = "Heatmap of Race and Age Groups", subtitle = "Suicidality")


suicidality %>% 
  group_by(race_concept_id, age_group) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(value = count/sum(count),
         race_concept_id = fct_reorder(race_concept_id, value)) %>% 
  ggplot(aes(x = age_group, y = race_concept_id))+
  geom_tile(aes(fill = value)) + 
  scale_y_discrete(labels = c("8527" = "White", 
                              "8516" = str_wrap("Black or African American", 12), 
                              "8515" = "Asian", "8522" = "Other Race", 
                              "8657" = str_wrap("American Indian or Alaska Native", 12)))+
  theme(axis.title = element_blank()) + 
  labs(title = "Heatmap of Race and Age Groups", subtitle = "Depression")

```

```{r}
# labels = function(x) str_wrap(x, width = 15)
bipolar %>%
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum,.desc = TRUE),
         age_group = fct_rev(age_group)) %>% 
  ggplot(aes(x = age_group, y = count)) +
  geom_bar(aes(fill = race_concept_id),
    stat = "identity", color = "white",
    position = position_dodge2(width = 1, preserve = "single")) +
  coord_flip()+
  facet_wrap(~gender_concept_id) + 
  scale_fill_nejm(labels = function(x) str_wrap(x, width = 20)) +
  theme_pubr(base_size = 12)+
  theme(legend.title = element_blank(),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(vjust = 1))+
  labs(fill = "", title = "Overview of Bipolar Disorder by Gender, Age, and Race", 
       x = "Age Group", y = "Count") 
```



```{r}
depression %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(age_group) %>% 
  summarise(count = sum(count)) %>% 
  mutate(freq = round(count/sum(count)*100, 2),
         cs = rev(cumsum(rev(freq))),
         pos = freq/2 + lead(cs,1),
         pos = if_else(is.na(pos), freq/2, pos), 
         top5 = rank(-count) %in% 1:5) %>% 
  ggplot(aes(x = age_group, y = count)) + 
  geom_line(size = 1.2, aes(group=1), color = "#0072B5FF",
            key_glyph = "rect") +
  geom_point(size = 1.6)+
  geom_bar(stat = "identity",
           position = position_dodge2(width = 0.7, preserve = "single"), 
           fill = "#0072B5FF",
           alpha= 0.3,
           show.legend = FALSE)+
  geom_text(aes(label = paste0(freq, "%")), position = position_stack(vjust = 0.5))+
  theme_pubr()+
  theme(legend.title = element_blank(),
        plot.margin = unit(c(1.5,.5,.5,.5), "cm"),
        plot.title = element_text(vjust = 3),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(angle =90, vjust = 2)) + 
  labs(x = "Age Group", y = "Count", 
       title = "Depression across Age Groups") -> dep_age


depression %>%
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(age_group, race_concept_id) %>% 
  summarise(count = sum(count)) %>% 
  ggplot(aes(x = age_group, y = count)) + 
  geom_line(size = 1.2, aes(group = race_concept_id, color = race_concept_id),
            key_glyph = "rect") + 
  geom_point(size = 1.6, aes(color = race_concept_id))+
  # geom_text(size = 4, aes(x = "Female", 
  #                         label = if_else(gender_concept_id == "Female", 
  #                                         str_wrap(race_concept_id,20), NULL), 
  #                         color = race_concept_id), nudge_x = 0.04, hjust = 0) +
  scale_color_nejm(labels = function(x) str_wrap(x, width = 20))+
  theme_pubr()+
  theme(panel.grid.major = element_line(color = "#DAE1E7"),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank()) + 
  labs(x = "", y = "Count", 
       title = "Interaction between Age and Race for Depression")


```


```{r}
depression %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE),
         gender_concept_id = fct_rev(gender_concept_id)) %>% 
  group_by(age_group, gender_concept_id) %>% 
  summarise(count = sum(count)) %>% 
  mutate(freq = round(count/sum(count)*100, 2),
         cs = rev(cumsum(rev(freq))),
         pos = freq/2 + lead(cs,1),
         pos = if_else(is.na(pos), freq/2, pos), 
         top5 = rank(-count) %in% 1:5) %>% 
  ggplot(aes(x = age_group, y = count)) + 
  geom_line(size = 1.2, aes(group=gender_concept_id, color = gender_concept_id),
            key_glyph = "rect") +
  geom_point(size = 1.6, aes(group=gender_concept_id, color = gender_concept_id), 
             show.legend = FALSE)+
  geom_bar(aes(fill = gender_concept_id), stat = "identity",
           position = position_dodge2(width = 0.7, preserve = "single"), 
           alpha= 0.3)+
  theme_pubr()+
  scale_color_nejm()+
  scale_fill_nejm()+
  theme(legend.title = element_blank(),
        plot.margin = unit(c(1.5,.5,.5,.5), "cm"),
        plot.title = element_text(vjust = 3),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(angle =90, vjust = 2)) + 
  labs(x = "Age Group", y = "Count", 
       title = "Depression across Age and Gender")
```



```{r, include = F}

# options(repr.plot.width = 4, repr.plot.height = 4)
# bipolar %>% group_by(race_concept_id) %>% summarize(count = sum(count)) %>% 
#   mutate(freq = round(count/sum(count)*100, 2),
#          cs = rev(cumsum(rev(freq))),
#          pos = freq/2 + lead(cs,1),
#          pos = if_else(is.na(pos), freq/2, pos), 
#          top5 = rank(-count) %in% 1:5, 
#          race_concept_id = fct_reorder(race_concept_id, freq, .desc = T)) %>% 
#   ggplot(aes(x = race_concept_id, y = count)) + 
#   geom_bar(aes(fill = race_concept_id), stat = "identity") +
#   geom_text(aes(label = count), color = "black", vjust = -.3)+
#    geom_text(aes(label = if_else(freq > 1, paste0(freq, "%"), "")), 
#              position = position_stack(vjust = .5))+
#    labs(title = "Distribution of Bipolar Cohort by Race", y = "Count") +
#    scale_fill_nejm()+
#    theme_classic() + 
#    theme(legend.position = "none", 
#          axis.title.x = element_blank())


bipolar %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(race_concept_id) %>% summarize(count = sum(count)) %>% 
  mutate(freq = round(count/sum(count)*100, 2),
         cs = rev(cumsum(rev(freq))),
         pos = freq/2 + lead(cs,1),
         pos = if_else(is.na(pos), freq/2, pos), 
         top5 = rank(-count) %in% 1:5) %>% 
  ggplot(aes(x = "", y = freq, fill = race_concept_id))+
  geom_bar(stat = "identity", width = 1, color = "white") + 
  theme_pubr()+
  coord_polar("y", start = 0)+
  labs(fill = "", 
       title = str_wrap("Overall Distribution of Bipolar Disorder by Race",30))+ 
  theme(panel.grid  = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x = element_blank(),
        axis.title.y = element_blank(), 
        legend.title = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line= element_blank(),
        plot.title = element_text(size = 12),
        legend.position = "bottom")+ 
   # geom_label_repel(aes(y = pos, 
   #                      label = if_else(top5, paste0(race_concept_id,
   #                                                   "\nCount:", 
   #                                                   count, ",\n", 
   #                                                   freq, "%"), NULL)),
   #                  size = 3, show.legend = F, color = "white",
   #                  max.overlaps = Inf, nudge_x = .5, min.segment.length = Inf)+
  geom_text(aes(y = pos, label = if_else(freq > 10, 
                                         paste0(freq, "%"), 
                                         NULL)))+
  scale_fill_nejm(labels = function(x) str_wrap(x, width = 18)) -> bd_race
  

```


```{r}
rbind(bipolar, depression, suicidality) %>%
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(race_concept_id, gender_concept_id, condition) %>% 
  summarise(sum = sum(count)) %>% 
  ggplot(aes(x = gender_concept_id, y = sum)) + 
  geom_line(size = 1.2, aes(group = race_concept_id, color = race_concept_id),
            key_glyph = "rect") + 
  geom_point(size = 1.6, aes(color = race_concept_id))+
  # geom_text(size = 4, aes(x = "Female", 
  #                         label = if_else(gender_concept_id == "Female", 
  #                                         str_wrap(race_concept_id,20), NULL), 
  #                         color = race_concept_id), nudge_x = 0.04, hjust = 0) +
  scale_color_nejm(labels = function(x) str_wrap(x, width = 20))+
  theme_pubr()+
  theme(panel.grid.major = element_line(color = "#DAE1E7"),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank()) + 
  labs(x = "", y = "Count", 
       title = "Interaction between Gender and Race")+
  facet_wrap(~condition, scales = "free") -> gender_race


rbind(bipolar, depression, suicidality) %>%
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(age_group, condition) %>% 
  summarise(sum = sum(count)) %>% 
  ggplot(aes(x = age_group, y = sum)) + 
  geom_line(size = 1.2, aes(group = condition, color = condition),
            key_glyph = "rect") + 
  geom_point(size = 1.6, aes(color = condition))+
  geom_bar(aes(fill = condition), stat = "identity",
           position = position_dodge2(width = 0.8, preserve = "single"), 
           alpha= 0.3,
           show.legend = FALSE) +
  scale_color_nejm(labels = function(x) str_wrap(x, width = 20))+
  scale_fill_nejm() + 
  scale_y_continuous(n.breaks = 4)+
  theme_pubr()+
  theme(legend.title = element_blank()) + 
  labs(x = "Age Group", y = "Count",
       title = "Interaction between Age and Condition")+
  facet_wrap(~condition, scales = "free_y", nrow = 3) -> age_condition


```



```{r}
bipolar %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  filter(race_concept_id == "White"| race_concept_id == "Black or African American") %>%
  group_by(race_concept_id, age_group) %>% 
  summarise(sum = sum(count)) %>% 
  ggplot(aes(x = age_group, y = sum)) + 
  geom_bar(aes(fill = race_concept_id), stat = "identity",
           width = 0.7, 
           position = "dodge") + 
  scale_fill_nejm(labels = function(x) str_wrap(x, width = 20)) + 
  theme_pubr(base_size = 9) + 
  theme(legend.position = "none",
        axis.title.x = element_text(vjust = -2),
        axis.title.y = element_text(vjust = 3),
        plot.margin = unit(c(1,0,.5,0), "cm"),
        plot.title = element_text(size = 12)) +
  labs(fill = "", 
       title = str_wrap("Age Differences in White vs Black or African American populations",40), 
       # subtitle = "White vs Black or African American populations"
       x = "Age Group", y = "Count" ) -> bd_bw

bipolar %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  filter(race_concept_id == "White"| race_concept_id == "Black or African American") %>% 
  ggplot(aes(x = age_group, y = count)) + 
  geom_bar(aes(fill = race_concept_id), stat = "identity",
           width = 0.7, position = "dodge") +
  scale_fill_nejm(labels = function(x) str_wrap(x, width = 20)) + 
  theme_pubr(base_size = 10) + 
  theme(plot.title = element_text(vjust = 1),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(angle = 90, vjust = 1),
        legend.position = "bottom") +
  labs(fill = "", 
       title = "Age Differences in White vs Black or African American populations",
       x = "Age Group", y = "Count") + 
  guides(fill = guide_legend(direction = "horizontal")) +
  facet_grid(~gender_concept_id) -> bd_bw_mf

# values = c("#0072B5FF", "#E18727FF"), 
# legend.background = element_rect(linetype = "solid", color = "black")

bipolar %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  group_by(race_concept_id, gender_concept_id) %>% 
  summarise(sum = sum(count)) %>% 
  ggplot(aes(x = race_concept_id, y = sum)) +
  geom_bar(aes(fill = gender_concept_id), stat = "identity", 
           width = 0.7, position = "dodge") + 
  scale_fill_manual(labels = function(x) str_wrap(x, width = 20), 
                    values = c("#0073C2FF", "#EFC000FF")) + 
  theme_pubr(base_size = 10) + 
  facet_wrap(~race_concept_id, scales = "free")


    

```


```{r}
bipolar %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  filter(race_concept_id == "White"| race_concept_id == "Black or African American") %>%
  group_by(race_concept_id, age_group) %>% 
  summarise(sum = sum(count)) %>% 
  filter(age_group == "80 - 89") %>% 
  mutate(race = case_when(race_concept_id == "White" ~ 0, 
                          race_concept_id == "Black or African American" ~ 1),
         race = as.factor(race)) -> bd_bw_label

depression %>% 
  mutate(race_concept_id = fct_reorder(race_concept_id, count, .fun = sum, .desc = TRUE)) %>% 
  filter(race_concept_id == "White"| race_concept_id == "Black or African American") %>%
  group_by(race_concept_id, age_group) %>% 
  summarise(sum = sum(count)) %>% 
  ggplot(aes(x = age_group, y = sum)) +
  geom_line(size = 1.2, aes(group = race_concept_id, color = race_concept_id)) + 
  geom_point(size = 1.6, aes(color = race_concept_id), shape = 15) + 
  theme_pubr() + 
  scale_color_nejm()+ 
  theme(panel.grid.major = element_line(color = "#DAE1E7"),
        panel.grid.major.x = element_blank(),
        legend.title = element_blank()) + 
```



```{r}
# ggarrange(ggarrange(bd_race, bd_bw, 
#                     widths = c(0.3, 0.7), 
#                     common.legend = T, legend = "bottom"), 
#           bd_bw_mf, nrow = 2, 
#           heights = c(.4, .6))

fig1 <- ggarrange(bd_race, bd_bw, widths = c(0.3, 0.7), common.legend = T, legend = "bottom")
annotate_figure(fig1, 
                top = text_grob("Comparing Bipolar Disorder Prevalence", 
                                size = 16, face = "bold"),
                fig.lab = "Figure 1", fig.lab.face = "bold")
```






```{r}
bipolar %>% filter(race_concept_id == "White") %>% 
  full_join(., (bipolar %>% filter(race_concept_id == "Black or African American")), 
            by = c("age_group", "gender_concept_id", "state", "condition")) %>% 
  select(-state, -condition) %>% 
  head()
```

