# Baseline Characterization of Bipolar Disorder, Depresssion, and Suicidality

## Executive Summary

*Date:* 2023-02-20

*Summary:* Characterization to assess prevalence of Bipolar Disorder, Depresssion, and Suicidality

## Running Characterization

### Packages

The following packages will be loaded to conduct the feasibility
assessment:

#### R Packages

The following R packages will be loaded to conduct the feasibility assessment:

```{r, eval = FALSE, message = FALSE}
library(dplyr)
library(tibble)
library(JuliaConnectoR)
```

To learn more about these packages, see the [Appendix](#appendix).

#### Julia Packages

The following Julia packages will be loaded to conduct the feasibility assessment:

```{r, eval = FALSE, message = FALSE}
library(JuliaConnectoR)

pkg <- juliaImport("Pkg")
pkg$activate("STUDY", shared = TRUE) 

juliaImport("OMOPCDMDatabaseConnector")

dbi <- juliaImport("DBInterface")
occ <- juliaImport("OMOPCDMCohortCreator")
```

To learn more about these packages, see the [Appendix](#appendix).

### Defining Connection Details to Other Databases

Here, we need to set-up connection to the OMOP CDM database we will
assess. To do so, we need to define some constants that will be used for
the connection. The following list of constants:

- `dbms` - the database management system that is used to host your
    database; common options include (see all options
    [here](http://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html))
  - mysql
  - postgresql
  - redshift
  - sqlite
  - sqlserver
- `server` - name of the server; could be `localhost`, an address like
    `123.0.1.5`, etc.
- `user` - your username to access the server
- `password` - the password you use to access the server
- `port` - the port where the database is hosted
- `schema` - name of the database schema used

Must be defined in this code block:

```{r, eval = FALSE}
dbms <- "Fill in here"
server <- "Fill in here"
user <- "Fill in here"
password <- "Fill in here"
port <- "Fill in here"
schema <- "Fill in here"
```

Now, we can define our connection string here using the defined constants: 

```{r, eval = F}
connectionString <- sprintf("host=%s port=%s user=%s password=%s", 
			    server, 
			    port, 
			    user, 
			    password)
```

With the connection string, we can create the connection to the
database:

```{r, eval = F}
conn <- dbi$connect(lq$Connection, connectionString)
```

NOTE: 

lq <- juliaImport("LibPQ")

#### Example Connection

If any of this was confusing, here is an example of how to fill out the
above connection information, activate our environment, and create a connection:

```{r, eval = F}
dbms <- ":postgresql"
server <- "test.data.americus.edu/mimic_omop"
user <- "mimic"
password <- "omoprocks"
port <- 5042
schema <- "mimic.omop"

connectionString <- sprintf("host=%s port=%s user=%s password=%s", server, port, user, password)

conn <- dbi$connect(lq$Connection, connectionString)
```

### Connecting to the Database and Testing Connection

With our connection details defined, we can generate the database connection details that `OMOPCDMCohortCreator` will use internally. For this step, we will use `OMOPCDMCohortCreator`, and we will need the name of the database management system and the database schema used, which were defined above.

```{r, eval = F}
occ$GenerateDatabaseDetails(juliaEval(paste0(":", dbms)), schema)
```

Finally, we will generate internal representations of each table found for `OMOPCDMCohortCreator` to use:

```{r, eval = F}
occ$GenerateTables(conn)
```

### Characterization Analysis and Queries

For this task, we want to load the concept set and get all of the concept IDs for our depression concept set.

1.  Load condition_concept_ids for a condition

**Bipolar Disorder**
```{r, eval = F}
pathToPhenotype_bipolar <- system.file("phenotypes", "bipolar_concept_set.csv", package ="MentalHealthEquity")
bipolar_concept_ids <- read.csv(pathToPhenotype_bipolar)$CONCEPT_ID
```

**Depression**

```{r, eval = F}
pathToPhenotype_depression <- system.file("phenotypes", "depression_concept_set.csv", package ="MentalHealthEquity")
depression_concept_ids <- read.csv(pathToPhenotype_depression)$CONCEPT_ID
```

**Suicidality**

```{r, eval = F}
pathToPhenotype_suicidality <- system.file("phenotypes", "suicidality_concept_set.csv", package ="MentalHealthEquity")
suicidality_concept_ids <- read.csv(pathToPhenotype_suicidality)$CONCEPT_ID
```



2.  Filter database patients to those captured by a concept set

**Bipolar Disorder**

```{r, eval = F}
bipolar_patients <- occ$ConditionFilterPersonIDs(bipolar_concept_ids, conn)
bipolar_patients <- bipolar_patients$person_id
```

**Depression**

```{r, eval = F}
depression_patients <- occ$ConditionFilterPersonIDs(depression_concept_ids, conn)
depression_patients <- depression_patients$person_id
```

**Suicidality**

```{r, eval = F}
suicidality_patients <- occ$ConditionFilterPersonIDs(suicidality_concept_ids, conn)
suicidality_patients <- suicidality_patients$person_id
```

#### Stratified Person Query

Now, we have all the person IDs of database patients captured by each
condition concept set. This next part of the tutorial focuses on
stratifying our database patients by race, gender, and age group. We
will be using the Julia package `OMOPCDMCohortCreator` to characterize
each person, and we will store this information in a tibble to be
exported as a csv.


#### Task 1: Find the race of patients

For this task, we will be using the `GetPatientRace()` function from the `OMOPCDMCohortCreator` package. 

**Bipolar Disorder**

```{r, eval = F}
bipolar_patients_race <- occ$GetPatientRace(bipolar_patients, conn)
```

**Depression**

```{r, eval = F}
depression_patients_race <- occ$GetPatientRace(depression_patients, conn)
```

**Suicidality**

```{r, eval = F}
suicidality_patients_race <- occ$GetPatientRace(suicidality_patients, conn)
```

#### Task 2: Find the gender of patients

For this task, we will be using the `GetPatientGender()` function from the `OMOPCDMCohortCreator` package. 

**Bipolar Disorder**

```{r, eval = F}
bipolar_patients_gender <- occ$GetPatientGender(bipolar_patients, conn)
```

**Depression**

```{r, eval = F}
depression_patients_gender <- occ$GetPatientGender(depression_patients, conn)
```

**Suicidality**

```{r, eval = F}
suicidality_patients_gender <- occ$GetPatientGender(suicidality_patients, conn)
```


#### Task 3: Create Age Groupings of Patients

For this task, for every single person who has a diagnosis of
depression, we need to assign them an age group. For this demo, age
groupings will be made along 55 year intervals when assigned to a person
up to `100` years of age (e.g. `[0, 4], [5, 9], ..., [95,100]`).

```{r, eval = F}
age_groups <- list(
	list(0, 4),
	list(5, 9),
	list(10, 14),
	list(15, 19),
	list(20, 24),
	list(25, 29),
	list(30, 34),
	list(35, 39),
	list(40, 44),
	list(45, 49),
	list(50, 54),
	list(55, 59),
	list(60, 64),
	list(65, 69),
	list(70, 74),
	list(75, 79),
	list(80, 84),
	list(85, 89),
	list(90, 94),
	list(95, 99))

```

**Bipolar Disorder**

```{r, eval = F}
bipolar_patients_age_group <- occ$GetPatientAgeGroup(bipolar_patients, conn, age_groupings = age_groups)
```

**Depression**

```{r, eval = F}
depression_patients_age_group <- occ$GetPatientAgeGroup(depression_patients, conn, age_groupings = age_groups)
```

**Suicidality**

```{r, eval = F}
suicidality_patients_age_group <- occ$GetPatientAgeGroup(suicidality_patients, conn, age_groupings = age_groups)
```

#### Task 4: Characterize Each Person by Race, Gender, and Age Group

With the previous tasks, we now know patients' gender, race, and age group. Using this information, we can combine these features to create a final table showing each patient's person_id, gender, race, and age group per row. To do this combining, we will use the `dplyr` and `tibble` packages:


**Bipolar Disorder**
```{r, eval = F}
library(dplyr)
library(tibble)

bipolar_patients <- tibble(data.frame(person_id=bipolar_patients))
bipolar_patients_race <- tibble(data.frame(bipolar_patients_race))
bipolar_patients_gender <- tibble(data.frame(bipolar_patients_gender))
bipolar_patients_age_group <- tibble(data.frame(bipolar_patients_age_group))
```

**Depression**

```{r, eval = F}
library(dplyr)
library(tibble)

depression_patients <- tibble(data.frame(person_id=depression_patients))
depression_patients_race <- tibble(data.frame(depression_patients_race))
depression_patients_gender <- tibble(data.frame(depression_patients_gender))
depression_patients_age_group <- tibble(data.frame(depression_patients_age_group))
```

**Suicidality**

```{r, eval = F}
library(dplyr)
library(tibble)

suicidality_patients <- tibble(data.frame(person_id=suicidality_patients))
suicidality_patients_race <- tibble(data.frame(suicidality_patients_race))
suicidality_patients_gender <- tibble(data.frame(suicidality_patients_gender))
suicidality_patients_age_group <- tibble(data.frame(suicidality_patients_age_group))
```


#### Task 5: Create Patient Groupings: Join the tables together 

Often with characterization style studies, it is extremely important to
aggregate patient populations. This is to protect the anonymity of
patients with perhaps severely sensitive conditions (e.g. mental
illnesses, sexually transmitted diseases, etc.) from possible
repercussions from accidental disclosure of this patient information.

**Bipolar Disorder**
```{r, eval = F}
bipolar_final_df <- full_join(bipolar_patients, bipolar_patients_race, by = c("person_id" = "person_id")) %>% 
  full_join(bipolar_patients_age_group, by = c("person_id" = "person_id")) %>%
  full_join(bipolar_patients_gender, by = c("person_id" = "person_id")) %>%
  select(-person_id) %>% 
  count(race_concept_id, age_group, gender_concept_id) %>%
  rename(count = "n") %>%
  filter(count > 10)
```

**Depression**

```{r, eval = F}
depression_final_df <- full_join(depression_patients, depression_patients_race, by = c("person_id" = "person_id")) %>% 
  full_join(depression_patients_age_group, by = c("person_id" = "person_id")) %>%
  full_join(depression_patients_gender, by = c("person_id" = "person_id")) %>%
  select(-person_id) %>% 
  count(race_concept_id, age_group, gender_concept_id) %>%
  rename(count = "n") %>%
  filter(count > 10)
```

**Suicidality**

```{r, eval = F}
suicidality_final_df <- full_join(suicidality_patients, suicidality_patients_race, by = c("person_id" = "person_id")) %>% 
  full_join(suicidality_patients_age_group, by = c("person_id" = "person_id")) %>%
  full_join(suicidality_patients_gender, by = c("person_id" = "person_id")) %>%
  select(-person_id) %>% 
  count(race_concept_id, age_group, gender_concept_id) %>%
  rename(count = "n") %>%
  filter(count > 10)
```


#### Task 6: Writing final output to CSV

**Bipolar Disorder**

```{r, eval = F}
exportFolder <- system.file("data", package = "MentalHealthEquity")

write.csv(bipolar_final_df, 
          file = file.path(exportFolder, "bipolar_person_stratified_breakdown.csv"), 
          row.names = FALSE)
```

**Depression**

```{r, eval = F}
exportFolder <- system.file("data", package = "MentalHealthEquity")

write.csv(depression_final_df, 
          file = file.path(exportFolder, "depression_person_stratified_breakdown.csv"), 
          row.names = FALSE)
```

**Suicidality**

```{r, eval = F}
exportFolder <- system.file("data", package = "MentalHealthEquity")

write.csv(suicidality_final_df, 
          file = file.path(exportFolder, "suicidality_person_stratified_breakdown.csv"), 
          row.names = FALSE)
```


### Conclusion

This concludes the tutorial for our characterization study. This mini characterization study that we just conducted on this dataset opens up a whole new avenue for a researcher to pursue. For example, we could now calculate prevalence rates across different patient characteristics or compare and contrast multiple conditions at once. It should also be apparent that the API is set up in a very particular way: it is functional meaning that each function does one thing only. This gives a lot of flexibility to a user to build together a study incrementally using `OMOPCDMCohortCreator.`


### Appendix

#### Packages Used in Analysis:

##### R Packages Used:

- `dplyr` - grammar of data manipulation
- `tibble` - modern reimagining of the data.frame
- `JuliaConnectoR` - a functionally oriented interface for calling Julia from R


##### Julia Packages Used:

-   `HealthSampleData` - Sample health data for a variety of health formats and use cases
-   `OMOPCDMDatabaseConnector` - Connect to databases utilizing the OMOP CDM 
-   `OMOPCDMCohortCreator` - Create cohorts from databases utilizing the OMOP CDM
-   `SQLite` - Julia interface to the SQLite library
-   `DBInterface` - Julia interface for common database operations and methods
-   `LibPQ` - Julia interface to the PostgreSQL library
